[
  {
    "iteration_id": 9,
    "parent_step_id": 156,
    "resolution": "L2",
    "sequence_number": 1,
    "title": "L2-7.1.1: Test draw call count < 30 for 100 courts",
    "description": "Create vitest test that instantiates a WebGLRenderer (or mocks it), renders InstancedCourts with 100 court positions, reads renderer.info.render.calls, asserts < 30. This is the primary KPI test.",
    "target_file": "src/__tests__/instancedCourts.perf.test.ts",
    "exact_instructions": "Test uses Three.js directly (not R3F) to avoid Canvas mounting complexity. Create a Scene, add InstancedMesh objects matching InstancedCourts component structure. Set instance count to 100. Render one frame. Check renderer.info.render.calls.\n\nAlternative: Test at the logic level - verify that the component creates exactly 7 InstancedMesh objects (not 1200+ individual meshes). This is testable without a real WebGL context.",
    "confidence_score": 0.8
  },
  {
    "iteration_id": 9,
    "parent_step_id": 157,
    "resolution": "L2",
    "sequence_number": 1,
    "title": "L2-7.2.1: Test court position matrix correctness",
    "description": "Create test that generates 10 court positions, applies the same matrix computation logic used in InstancedCourts, then extracts translation components from each matrix and compares to input positions.",
    "target_file": "src/__tests__/instancedCourts.perf.test.ts",
    "exact_instructions": "Test: Create Matrix4, call makeTranslation(x, 0, z) for each position. Extract position via matrix.elements[12], [13], [14] (translation column). Assert closeTo(expectedX, 0.001) and closeTo(expectedZ, 0.001). Test post matrices have correct +/- POST_OFFSET_X offsets.",
    "confidence_score": 0.95
  },
  {
    "iteration_id": 9,
    "parent_step_id": 158,
    "resolution": "L2",
    "sequence_number": 1,
    "title": "L2-7.3.1: Test matrix update only on layout change",
    "description": "Verify that the component design ensures matrix updates are gated by courtPositions dependency. Test at the unit level by verifying the useEffect dependency array structure.",
    "target_file": "src/__tests__/instancedCourts.perf.test.ts",
    "exact_instructions": "This is more of an architectural assertion. Test by verifying: (1) courtPositions is computed via useMemo in parent, (2) InstancedCourts useEffect for matrices depends on courtPositions, (3) no useFrame hooks exist in InstancedCourts. Can be tested via code analysis or by rendering twice with same props and asserting needsUpdate is not re-triggered.",
    "confidence_score": 0.8
  },
  {
    "iteration_id": 9,
    "parent_step_id": 159,
    "resolution": "L2",
    "sequence_number": 1,
    "title": "L2-7.4.1: Test click handler receives correct court ID",
    "description": "Test that clicking on a court position calls onSelect with the correct courtId. Since click targets are standard R3F meshes (not instanced), this tests the mapping from position to court ID.",
    "target_file": "src/__tests__/instancedCourts.perf.test.ts",
    "exact_instructions": "Unit test: Given courtPositions = [{x:0, z:0, id:'court-0-0'}, {x:10, z:0, id:'court-0-1'}], simulate click handler call for index 1. Assert onSelect was called with ('court-0-1', false). This tests the closure capture of pos.id in the click handler.",
    "confidence_score": 0.9
  },
  {
    "iteration_id": 9,
    "parent_step_id": 160,
    "resolution": "L2",
    "sequence_number": 1,
    "title": "L2-7.5.1: Test selection visibility via instance matrices",
    "description": "Test that when a court is in selectedCourtIds, its selection outline instance has non-zero scale, and unselected courts have zero scale.",
    "target_file": "src/__tests__/instancedCourts.perf.test.ts",
    "exact_instructions": "Unit test: Create Matrix4, apply the selection logic. For selected court at index 2: matrix should have translation (x, -0.02, z) and scale (1,1,1). For unselected court at index 0: matrix should have scale (0,0,0). Extract scale from matrix via decompose() or check determinant === 0 for zero-scale.",
    "confidence_score": 0.9
  }
]
