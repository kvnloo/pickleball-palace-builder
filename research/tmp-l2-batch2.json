[
  {
    "iteration_id": 9,
    "parent_step_id": 142,
    "resolution": "L2",
    "sequence_number": 1,
    "title": "L2-2.1.1: Create InstancedCourts.tsx with interface and imports",
    "description": "Create src/components/three/InstancedCourts.tsx. Define InstancedCourtsProps interface. Import React hooks, THREE, R3F types, court geometries module, and facility types.",
    "target_file": "src/components/three/InstancedCourts.tsx",
    "exact_instructions": "Create file with:\nimport { useRef, useMemo, useEffect, useState, useCallback } from 'react';\nimport * as THREE from 'three';\nimport { ThreeEvent } from '@react-three/fiber';\nimport { CourtState, SurfaceType, SURFACE_MATERIALS, getStatusColor } from '@/types/facility';\nimport { courtSurfaceGeometry, mergedLineGeometry, netGeometry, postGeometry, courtMaterials, overlayGeometries, POST_OFFSET_X, NET_Y } from './courtGeometries';\n\ninterface InstancedCourtsProps {\n  courtPositions: Array<{ x: number; z: number; id: string }>;\n  courts: Map<string, CourtState>;\n  selectedCourtIds: Set<string>;\n  surfaceType: SurfaceType;\n  showNet: boolean;\n  showLines: boolean;\n  onSelect: (courtId: string, shiftKey: boolean) => void;\n}",
    "confidence_score": 0.95
  },
  {
    "iteration_id": 9,
    "parent_step_id": 142,
    "resolution": "L2",
    "sequence_number": 2,
    "title": "L2-2.1.2: Define refs for all InstancedMesh objects",
    "description": "Inside the component function, create useRef<THREE.InstancedMesh>(null) for: surfaceRef, linesRef, netRef, postsRef (2x count), statusRingRef, selectionRef, dirtyOverlayRef. Also create a tempMatrix ref for reusable Matrix4.",
    "target_file": "src/components/three/InstancedCourts.tsx",
    "exact_instructions": "Inside export function InstancedCourts(props):\nconst surfaceRef = useRef<THREE.InstancedMesh>(null);\nconst linesRef = useRef<THREE.InstancedMesh>(null);\nconst netRef = useRef<THREE.InstancedMesh>(null);\nconst postsRef = useRef<THREE.InstancedMesh>(null);\nconst statusRingRef = useRef<THREE.InstancedMesh>(null);\nconst selectionRef = useRef<THREE.InstancedMesh>(null);\nconst dirtyOverlayRef = useRef<THREE.InstancedMesh>(null);\nconst tempMatrix = useRef(new THREE.Matrix4());\nconst tempColor = useRef(new THREE.Color());",
    "confidence_score": 0.98
  },
  {
    "iteration_id": 9,
    "parent_step_id": 143,
    "resolution": "L2",
    "sequence_number": 1,
    "title": "L2-2.2.1: Compute and apply surface/lines/net matrices",
    "description": "In a useEffect keyed on [courtPositions], loop through positions and set matrices for surface, lines, and net InstancedMeshes. All three use simple translation to (x, 0, z). Set instanceMatrix.needsUpdate = true after.",
    "target_file": "src/components/three/InstancedCourts.tsx",
    "exact_instructions": "useEffect(() => {\n  const count = courtPositions.length;\n  const mat = tempMatrix.current;\n  courtPositions.forEach((pos, i) => {\n    mat.makeTranslation(pos.x, 0, pos.z);\n    surfaceRef.current?.setMatrixAt(i, mat);\n    linesRef.current?.setMatrixAt(i, mat);\n    // Net positioned at center of court, raised to NET_Y\n    mat.makeTranslation(pos.x, NET_Y, pos.z);\n    netRef.current?.setMatrixAt(i, mat);\n  });\n  [surfaceRef, linesRef, netRef].forEach(ref => {\n    if (ref.current) {\n      ref.current.count = count;\n      ref.current.instanceMatrix.needsUpdate = true;\n    }\n  });\n}, [courtPositions]);",
    "confidence_score": 0.9
  },
  {
    "iteration_id": 9,
    "parent_step_id": 143,
    "resolution": "L2",
    "sequence_number": 2,
    "title": "L2-2.2.2: Compute and apply post matrices (2 per court)",
    "description": "Posts have 2 instances per court (left post, right post). Loop through courtPositions, set matrix at index 2*i for left post and 2*i+1 for right post. Posts are positioned at (x +/- POST_OFFSET_X, NET_Y, z).",
    "target_file": "src/components/three/InstancedCourts.tsx",
    "exact_instructions": "Inside the same useEffect:\ncourtPositions.forEach((pos, i) => {\n  // Left post\n  mat.makeTranslation(pos.x - POST_OFFSET_X, NET_Y, pos.z);\n  postsRef.current?.setMatrixAt(i * 2, mat);\n  // Right post\n  mat.makeTranslation(pos.x + POST_OFFSET_X, NET_Y, pos.z);\n  postsRef.current?.setMatrixAt(i * 2 + 1, mat);\n});\nif (postsRef.current) {\n  postsRef.current.count = count * 2;\n  postsRef.current.instanceMatrix.needsUpdate = true;\n}",
    "confidence_score": 0.9
  },
  {
    "iteration_id": 9,
    "parent_step_id": 143,
    "resolution": "L2",
    "sequence_number": 3,
    "title": "L2-2.2.3: Compute overlay matrices (statusRing, dirtyOverlay)",
    "description": "Status rings and dirty overlays are positioned at court center with slight Y offset. Both are PlaneGeometry/RingGeometry that need rotation (-PI/2 around X). Encode rotation into the matrix.",
    "target_file": "src/components/three/InstancedCourts.tsx",
    "exact_instructions": "Add a rotationMatrix ref: const rotXMatrix = useRef(new THREE.Matrix4().makeRotationX(-Math.PI / 2));\n\nInside useEffect:\nconst rotX = rotXMatrix.current;\ncourtPositions.forEach((pos, i) => {\n  // Status ring at y=0.01, rotated\n  mat.makeTranslation(pos.x, 0.01, pos.z).multiply(rotX);\n  statusRingRef.current?.setMatrixAt(i, mat);\n  // Dirty overlay at y=0.03, rotated\n  mat.makeTranslation(pos.x, 0.03, pos.z).multiply(rotX);\n  dirtyOverlayRef.current?.setMatrixAt(i, mat);\n});\nUpdate counts and needsUpdate for both refs.",
    "confidence_score": 0.85
  },
  {
    "iteration_id": 9,
    "parent_step_id": 144,
    "resolution": "L2",
    "sequence_number": 1,
    "title": "L2-2.3.1: Set instance count on mount",
    "description": "Ensure all InstancedMesh objects have correct .count values set. Surface/lines/net/statusRing/selection/dirty = courtPositions.length. Posts = 2 * courtPositions.length.",
    "target_file": "src/components/three/InstancedCourts.tsx",
    "exact_instructions": "This is handled in the matrix computation useEffect above. Ensure count is set BEFORE needsUpdate to avoid rendering uninitialized instances. The args parameter in JSX sets the maximum capacity, while .count sets actual rendered count.",
    "confidence_score": 0.95
  },
  {
    "iteration_id": 9,
    "parent_step_id": 145,
    "resolution": "L2",
    "sequence_number": 1,
    "title": "L2-2.4.1: Render surface InstancedMesh",
    "description": "Render <instancedMesh> for court surfaces with per-instance color support.",
    "target_file": "src/components/three/InstancedCourts.tsx",
    "exact_instructions": "In the JSX return:\n<instancedMesh\n  ref={surfaceRef}\n  args={[courtSurfaceGeometry, undefined, courtPositions.length]}\n  frustumCulled={false}\n  receiveShadow\n>\n  <meshStandardMaterial roughness={0.5} metalness={0.05} />\n</instancedMesh>\nNote: material is inline because per-instance color overrides the base color. The shared material needs roughness/metalness from surfaceType config.",
    "confidence_score": 0.9
  },
  {
    "iteration_id": 9,
    "parent_step_id": 145,
    "resolution": "L2",
    "sequence_number": 2,
    "title": "L2-2.4.2: Render lines, net, and posts InstancedMeshes",
    "description": "Render <instancedMesh> for merged lines, net, and posts. Lines and posts use frustumCulled={false}.",
    "target_file": "src/components/three/InstancedCourts.tsx",
    "exact_instructions": "JSX:\n{showLines && (\n  <instancedMesh ref={linesRef} args={[mergedLineGeometry, courtMaterials.line, courtPositions.length]} frustumCulled={false} />\n)}\n{showNet && (\n  <>\n    <instancedMesh ref={netRef} args={[netGeometry, courtMaterials.net, courtPositions.length]} frustumCulled={false} />\n    <instancedMesh ref={postsRef} args={[postGeometry, courtMaterials.post, courtPositions.length * 2]} frustumCulled={false} />\n  </>\n)}",
    "confidence_score": 0.95
  },
  {
    "iteration_id": 9,
    "parent_step_id": 145,
    "resolution": "L2",
    "sequence_number": 3,
    "title": "L2-2.4.3: Render overlay InstancedMeshes (statusRing, selection, dirty)",
    "description": "Render <instancedMesh> for status rings, selection outlines, and dirty overlays. These use per-instance color and/or matrix-based visibility.",
    "target_file": "src/components/three/InstancedCourts.tsx",
    "exact_instructions": "JSX:\n<instancedMesh ref={statusRingRef} args={[overlayGeometries.statusRing, courtMaterials.statusRing, courtPositions.length]} frustumCulled={false} />\n<instancedMesh ref={selectionRef} args={[overlayGeometries.outline, courtMaterials.selected, courtPositions.length]} frustumCulled={false} />\n<instancedMesh ref={dirtyOverlayRef} args={[overlayGeometries.overlay, courtMaterials.dirtyOverlay, courtPositions.length]} frustumCulled={false} />",
    "confidence_score": 0.9
  }
]
